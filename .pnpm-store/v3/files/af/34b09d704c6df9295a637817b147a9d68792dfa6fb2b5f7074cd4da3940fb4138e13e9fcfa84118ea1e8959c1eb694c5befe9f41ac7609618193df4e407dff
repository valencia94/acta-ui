// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
import { StorageAction } from '@aws-amplify/core/internals/utils';
import { resolveS3ConfigAndInput } from '../../utils';
import { listObjectsV2, } from '../../utils/client';
import { getStorageUserAgentValue } from '../../utils/userAgent';
const MAX_PAGE_SIZE = 1000;
export const list = async (amplify, input) => {
    const { options = {}, prefix: path = '' } = input ?? {};
    const { s3Config, bucket, keyPrefix: prefix, } = await resolveS3ConfigAndInput(amplify, options);
    const listParams = {
        Bucket: bucket,
        Prefix: `${prefix}${path}`,
        MaxKeys: options?.listAll ? undefined : options?.pageSize,
        ContinuationToken: options?.listAll ? undefined : options?.nextToken,
    };
    return options.listAll
        ? await _listAll({ s3Config, listParams, prefix })
        : await _list({ s3Config, listParams, prefix });
};
const _listAll = async ({ s3Config, listParams, prefix, }) => {
    // TODO(ashwinkumar6) V6-logger: pageSize and nextToken aren't required when listing all items
    const listResult = [];
    let continuationToken = listParams.ContinuationToken;
    do {
        const { items: pageResults, nextToken: pageNextToken } = await _list({
            prefix,
            s3Config,
            listParams: {
                ...listParams,
                ContinuationToken: continuationToken,
                MaxKeys: MAX_PAGE_SIZE,
            },
        });
        listResult.push(...pageResults);
        continuationToken = pageNextToken;
    } while (continuationToken);
    return {
        items: listResult,
    };
};
const _list = async ({ s3Config, listParams, prefix, }) => {
    const listParamsClone = { ...listParams };
    if (!listParamsClone.MaxKeys || listParamsClone.MaxKeys > MAX_PAGE_SIZE) {
        listParamsClone.MaxKeys = MAX_PAGE_SIZE;
        // TODO(ashwinkumar6) V6-logger: defaulting pageSize to ${MAX_PAGE_SIZE}.
    }
    const response = await listObjectsV2({
        ...s3Config,
        userAgentValue: getStorageUserAgentValue(StorageAction.List)
    }, listParamsClone);
    if (!response?.Contents) {
        return {
            items: [],
        };
    }
    const listResult = response.Contents.map(item => ({
        key: item.Key.substring(prefix.length),
        eTag: item.ETag,
        lastModified: item.LastModified,
        size: item.Size,
    }));
    return {
        items: listResult,
        nextToken: response.NextContinuationToken,
    };
};
