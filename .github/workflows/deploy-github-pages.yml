name: Deploy to GitHub Pages (DISABLED)

# DISABLED: Use bulletproof-deploy.yml for AWS deployment instead
# This prevents duplicate deployments on every push
on:
  # push:
  #   branches: [develop]
  workflow_dispatch: {}

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸ› ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¼ Prettier format
        run: pnpm exec prettier --write .

      - name: ğŸ§¼ ESLint auto-fix
        run: pnpm exec eslint . --fix

      - name: ğŸ” ESLint verify
        run: pnpm exec eslint .

      - name: ğŸ§ª Lint + TS
        run: pnpm lint

      - name: âœ… Vitest unit tests
        run: pnpm run test:vitest -- --run --passWithNoTests

      - name: ğŸ”¨ Build React App
        env:
          # Use GitHub Pages URL for production build
          VITE_API_BASE_URL: "https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"
        run: |
          # Set base path for GitHub Pages (repository name)
          echo "Building for GitHub Pages with base path: /acta-ui/"
          pnpm run build -- --base=/acta-ui/

      - name: ğŸ“‹ Verify Build Output
        run: |
          echo "ğŸ“‹ VERIFYING BUILD OUTPUT"
          echo "========================"
          
          # Check if dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found!"
            exit 1
          fi
          
          # Check essential files
          echo "ğŸ” Checking essential files..."
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          echo "âœ… index.html found"
          
          # Check assets directory
          if [ ! -d "dist/assets" ]; then
            echo "âŒ assets directory not found!"
            exit 1
          fi
          echo "âœ… assets directory found"
          
          # Count files
          TOTAL_FILES=$(find dist -type f | wc -l)
          ASSET_FILES=$(find dist/assets -type f | wc -l)
          
          echo "ğŸ“Š Build Statistics:"
          echo "   Total files: $TOTAL_FILES"
          echo "   Asset files: $ASSET_FILES"
          
          # List key files
          echo "ğŸ“ Key files:"
          ls -la dist/index.html
          ls -la dist/assets/ | head -5
          
          # Check file sizes
          echo "ğŸ“ File sizes:"
          du -sh dist/
          du -sh dist/assets/

      - name: ğŸ› ï¸ Setup Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  # Deployment job
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ§ª Post-Deployment Verification
        run: |
          echo "ğŸ§ª POST-DEPLOYMENT VERIFICATION"
          echo "==============================="
          
          # Get the Pages URL
          PAGES_URL="${{ steps.deployment.outputs.page_url }}"
          echo "ğŸŒ GitHub Pages URL: $PAGES_URL"
          
          # Wait for deployment to propagate
          echo "â³ Waiting for deployment propagation..."
          sleep 30
          
          # Test the deployment
          echo "ğŸ” Testing deployment..."
          
          # Test main page
          if curl -sf "$PAGES_URL" > /dev/null; then
            echo "âœ… Main page accessible"
          else
            echo "âŒ Main page not accessible"
            exit 1
          fi
          
          # Test SPA routes (should all return the same index.html)
          for route in "login" "dashboard"; do
            if curl -sf "${PAGES_URL}${route}" > /dev/null; then
              echo "âœ… Route /${route} accessible"
            else
              echo "âŒ Route /${route} not accessible"
            fi
          done
          
          echo "ğŸ‰ GitHub Pages deployment verified!"
