# .github/workflows/build_deploy.yml
name: Build and Deploy

on:
  push:
    branches: [develop]           # auto-deploy only from develop
  pull_request:
    branches: [develop]           # PRs still lint / unit-test
  workflow_dispatch: {}           # manual trigger

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      id-token: write             # OIDC for AWS
      contents: read

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0) Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v4

    # 0.1) Make sure dist/health will exist
    - name: ğŸ’š add static /health
      run: |
        mkdir -p public
        echo '{"status":"ok"}' > public/health

    # 0.2) Prettier â€“ auto-fix (âœ– excludes workflow files)
    - uses: pnpm/action-setup@v2
      with: { version: 9 }
    - name: ğŸ§¼ format
      run: pnpm exec prettier --write \
           "**/*.{js,ts,tsx,css,md,yaml,yml,json}" \
           "!.github/workflows/*.yml"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) Install deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: pnpm
    - run: pnpm install --no-frozen-lockfile

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) Lint & unit tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” ESLint & types
      run: pnpm lint
    - name: ğŸ§ª Vitest
      run: pnpm run test:vitest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) Build UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Inject API base URL
      run: echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" >> "$GITHUB_ENV"

    - name: ğŸ—ï¸ build (Vite)
      run: pnpm run build                          # â†’ dist/

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) local smoke check (HTML returns 200) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ local preview smoke
      run: |
        pnpm exec vite preview --port 4173 --strictPort &  server=$!
        sleep 4
        curl -sf http://localhost:4173/           # 200 or exit 22
        kill $server

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) AWS credentials (OIDC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: aws-actions/configure-aws-credentials@v4
      if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region:     ${{ secrets.AWS_REGION }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6) Deploy SAM stack (backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â˜ï¸ SAM deploy
      if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
      env: { ARTIFACT_BUCKET: ${{ secrets.ARTIFACT_BUCKET }} }
      run: |
        pip install -q aws-sam-cli
        sam package \
          --template-file infra/template.yaml \
          --s3-bucket   "$ARTIFACT_BUCKET" \
          --output-template-file packaged.yaml
        sam deploy \
          --template-file packaged.yaml \
          --stack-name acta-backend-staging \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7) Backend /health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ¡ï¸ API /health
      if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
      run: curl -sf "${{ secrets.VITE_API_BASE_URL }}/health"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8) Upload UI & fast-purge CF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸš€ deploy UI (S3 + CF)
      if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
      env:
        BUCKET:    ${{ secrets.S3_BUCKET_NAME }}
        DIST_ID:   ${{ secrets.CLOUDFRONT_DIST_ID }}
      run: |
        set -eux
        # sync all & overwrite /health with no-cache
        aws s3 sync dist "s3://$BUCKET" --delete
        aws s3 cp dist/health "s3://$BUCKET/health" \
          --cache-control 'no-cache, no-store, must-revalidate' \
          --content-type 'application/json'

        INV=$(aws cloudfront create-invalidation \
          --distribution-id "$DIST_ID" --paths '/index.html' \
          --query 'Invalidation.Id' --output text)
        echo "ğŸ•’ waiting for invalidation $INVâ€¦"
        aws cloudfront wait invalidation-completed \
          --distribution-id "$DIST_ID" --id "$INV"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9) CloudFront /health probe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ UI /health via CF
      if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
      env: { DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }} }
      run: |
        set -e
        CF_DOMAIN=$(aws cloudfront get-distribution \
          --id "$DIST_ID" --query 'Distribution.DomainName' --output text)
        echo "CloudFront domain: $CF_DOMAIN"

        delay=5
        for n in {1..8}; do
          echo "Ping https://$CF_DOMAIN/health (try $n)â€¦"
          curl -fs "https://$CF_DOMAIN/health" && exit 0
          sleep $delay; delay=$((delay*2))
        done
        echo "UI /health failed âœ–"; curl -v "https://$CF_DOMAIN/health" || true
        exit 1
