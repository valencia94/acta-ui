name: Build and Deploy

on:
  push:
    branches: [develop]
  workflow_dispatch: {}

# Prevent two jobs from updating the same CF stack
concurrency:
  group: backend-deploy
  cancel-in-progress: true

jobs:
  ci_deploy:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      id-token: write
      contents: read

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Toolchain â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ› ï¸ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: ðŸ› ï¸ Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: pnpm

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Install / Lint / Test â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¦ Install deps
      run: pnpm install --frozen-lockfile

    - name: ðŸ§¼ Prettier format
      run: pnpm exec prettier --write .

    - name: ðŸ§¼ ESLint auto-fix
      run: pnpm exec eslint . --fix

    - name: ðŸ” ESLint verify
      run: pnpm exec eslint .

    - name: ðŸ§ª Lint + TS
      run: pnpm lint

    - name: âœ… Vitest unit tests
      run: pnpm run test:vitest -- --run --passWithNoTests

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Build UI â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ”¨ Build UI
      run: |
        echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" >> "$GITHUB_ENV"
        pnpm run build

    - name: ðŸ“‚ List dist
      run: ls -R dist

    - name: ðŸŒ Smoke test build
      run: |
        pnpm exec vite preview --port 4173 --strictPort & srv=$!
        sleep 6 && curl -sf http://localhost:4173/
        kill $srv

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. AWS creds â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Configure AWS creds
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Wait / cancel busy stack â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â³ Ensure backend stack free
      env:
        STACK_NAME: acta-api-wiring-stack-manual
        REGION: ${{ secrets.AWS_REGION }}
      run: |
        set -euo pipefail
        STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
                 --region "$REGION" --query 'Stacks[0].StackStatus' --output text \
                 2>/dev/null || echo NONE)
        if [[ "$STATUS" == *_IN_PROGRESS ]]; then
          aws cloudformation cancel-update-stack --stack-name "$STACK_NAME" --region "$REGION" || true
        fi
        while true; do
          STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
                   --region "$REGION" --query 'Stacks[0].StackStatus' --output text \
                   2>/dev/null || echo NONE)
          echo "  â†’ $STATUS"
          case "$STATUS" in
            CREATE_IN_PROGRESS|UPDATE_IN_PROGRESS|UPDATE_ROLLBACK_IN_PROGRESS|ROLLBACK_IN_PROGRESS|UPDATE_COMPLETE_CLEANUP_IN_PROGRESS)
              sleep 15 ;;
            CREATE_COMPLETE|UPDATE_COMPLETE|UPDATE_ROLLBACK_COMPLETE|ROLLBACK_COMPLETE|NONE)
              break ;;
            *) echo "Unexpected state $STATUS"; exit 1 ;;
          esac
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Package & deploy backend â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¦ SAM package backend
      env:
        ARTIFACT_BUCKET: ${{ secrets.SAM_ARTIFACTS_BUCKET }}
      run: |
        sam package \
          --template-file infra/template-conflict-free.yaml \
          --output-template-file infra/template-conflict-free-packaged.yaml \
          --s3-bucket "$ARTIFACT_BUCKET" \
          --region ${{ secrets.AWS_REGION }}

    - name: ðŸš€ SAM deploy backend
      run: |
        set -euxo pipefail
        TS=$(date +%Y%m%d-%H%M%S)
        sam deploy \
          --template-file infra/template-conflict-free-packaged.yaml \
          --stack-name acta-api-wiring-stack-manual \
          --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
          --region ${{ secrets.AWS_REGION }} \
          --no-fail-on-empty-changeset \
          --parameter-overrides DeploymentTimestamp="$TS"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Sync UI â†’ S3 â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸš€ Sync dist â†’ S3
      env:
        BUCKET: ${{ secrets.S3_BUCKET_NAME }}
      run: |
        aws s3 sync dist "s3://$BUCKET" --delete
        bash scripts/push-spa-routes.sh

    - name: ðŸ§¾ List S3
      env:
        BUCKET: ${{ secrets.S3_BUCKET_NAME }}
      run: aws s3 ls "s3://$BUCKET/" --recursive

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. Ensure CF root object â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ› ï¸ Ensure CF default root
      env:
        DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
      run: |
        set -euo pipefail
        tmp=$(mktemp)
        aws cloudfront get-distribution-config --id "$DIST_ID" > "$tmp"
        etag=$(jq -r .ETag "$tmp")
        root=$(jq -r .DistributionConfig.DefaultRootObject "$tmp")
        if [[ "$root" != "index.html" ]]; then
          jq '.DistributionConfig.DefaultRootObject = "index.html" | .DistributionConfig' "$tmp" > /tmp/cf_patch.json
          aws cloudfront update-distribution --id "$DIST_ID" --if-match "$etag" \
            --distribution-config file:///tmp/cf_patch.json
        fi
        rm -f "$tmp"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. Apply OAC bucket policy â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Apply OAC bucket policy
      env:
        BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
      run: |
        set -euo pipefail
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        cat > /tmp/oac.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "OACAccess",
              "Effect": "Allow",
              "Principal": { "Service": "cloudfront.amazonaws.com" },
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::$BUCKET/*",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": "arn:aws:cloudfront::$ACCOUNT:distribution/$DIST_ID"
                }
              }
            }
          ]
        }
        EOF
        aws s3api put-bucket-policy --bucket "$BUCKET" --policy file:///tmp/oac.json

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. CF invalidate & quick checks â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ”„ CF invalidate & verify
      env:
        DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
      run: |
        set -euo pipefail
        iid=$(aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths '/*' \
               --query 'Invalidation.Id' --output text)
        aws cloudfront wait invalidation-completed --distribution-id "$DIST_ID" --id "$iid"
        CF_DOMAIN=$(aws cloudfront get-distribution --id "$DIST_ID" \
                     --query 'Distribution.DomainName' --output text)
        echo "CloudFront Domain â†’ https://$CF_DOMAIN"
        curl -sf https://$CF_DOMAIN/login      || true
        curl -sf https://$CF_DOMAIN/dashboard  || true
