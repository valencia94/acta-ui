name: Build and Deploy

on:
  push:
    branches: [develop] # push to feature branches wonâ€™t deploy
  pull_request: # PRs still get lint/test
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    environment: prod # for OIDC role-to-assume
    permissions:
      id-token: write
      contents: read

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0) Checkout  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) Node + pnpm + cache  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â™»ï¸  pnpm cache & install
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: |
            args: [--no-frozen-lockfile]
        env:
          CI: true # keep scripts/prepare from running

      - name: ğŸŸ¢  Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) Lint / Type-check / Unit tests â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”  Lint & type-check
        run: pnpm lint

      - name: ğŸ§ª  Unit tests
        run: pnpm run test:vitest

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) Build  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Inject API base URL
        run: echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" >> "$GITHUB_ENV"

      - name: ğŸ—ï¸  Build UI
        run: pnpm run build

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) Playwright  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: E2E tests
        run: |
          pnpm exec playwright install --with-deps
          pnpm exec playwright test || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) Deploy (only on develop or manual) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure AWS credentials (OIDC)
        if: github.ref == 'refs/heads/develop' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - id: filter
        if: (github.ref == 'refs/heads/develop' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infra/**'

      - name: â˜ï¸  Deploy API (CloudFormation)
        if: steps.filter.outputs.infra == 'true'
        run: |
          aws cloudformation deploy \
            --stack-name acta-backend-staging \
            --template-file infra/template.yaml \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset

      - name: ğŸš€  Deploy UI to S3 + invalidate CloudFront
        if: github.ref == 'refs/heads/develop' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          chmod +x scripts/deploy-to-s3.sh
          ./scripts/deploy-to-s3.sh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6) Smoke test unified API â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: API smoke test
        if: github.ref == 'refs/heads/develop' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        env:
          API_BASE: ${{ secrets.VITE_API_BASE_URL }}
        run: curl -sf "$API_BASE/health"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7) Upload Playwright report  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦  Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 3
