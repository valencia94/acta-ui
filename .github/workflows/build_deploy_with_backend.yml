# .github/workflows/build_deploy_with_backend.yml
name: ðŸš€ Build, Deploy Frontend + Backend

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy simplified backend (Lambda-centric)'
        required: true
        default: true
        type: boolean
      test_backend_endpoints:
        description: 'Test backend endpoints after deployment'
        required: true
        default: true
        type: boolean

jobs:
  ci_deploy:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      id-token: write
      contents: read

    steps:
      # â”€â”€â”€ 0. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€ 1. Node & pnpm toolchain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: pnpm/action-setup@v2
        with: { version: 9 }

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # â”€â”€â”€ 2. Install, Format, Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - run: pnpm install --frozen-lockfile

      - name: ðŸ§¼ Prettier Format (Auto-Fix)
        run: pnpm exec prettier --write .

      - name: ðŸ§¼ Lint auto-fix
        run: pnpm exec eslint . --fix

      - name: ðŸ” Re-run lint to validate
        run: pnpm exec eslint .

      - name: ðŸ§ª Lint + TypeScript
        run: pnpm lint

      - name: âœ… Vitest Unit Tests
        run: pnpm run test:vitest -- --run --passWithNoTests

      # â”€â”€â”€ 3. Build (Vite) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”¨ Build UI
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" >> "$GITHUB_ENV"
          pnpm run build

      - name: ðŸ“‚ List dist/ before upload
        run: ls -R dist

      # â”€â”€â”€ 4. Local Preview Smoke Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŒ Local preview smoke test
        run: |
          pnpm exec vite preview --port 4173 --strictPort & SERVER=$!
          sleep 5 && curl -sf http://localhost:4173/
          kill $SERVER

      # â”€â”€â”€ 5. AWS Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # â”€â”€â”€ 5.5. ENHANCED: Deploy Simplified Backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŽ¯ Deploy Simplified Backend (Lambda-Centric)
        if: ${{ inputs.deploy_backend || github.event_name == 'push' }}
        run: |
          echo "ðŸŽ¯ Deploying Simplified Backend (Lambda-Centric)"
          echo "==============================================="
          echo "ðŸ”§ Strategy: Route all PM endpoints to existing projectMetadataEnricher"
          echo "ðŸ’° Benefits: No new Lambda functions, no DynamoDB costs, faster responses"
          echo
          
          # Deploy CloudFormation stack
          echo "ðŸ“¦ Deploying CloudFormation stack..."
          aws cloudformation deploy \
            --template-file infra/template-simplified-lambda.yaml \
            --stack-name acta-simplified-backend \
            --parameter-overrides \
              ExistingApiId=q2b9avfwv5 \
              ExistingApiRootResourceId=kw8f8zihjg \
            --capabilities CAPABILITY_IAM \
            --region us-east-2
            
          echo "âœ… CloudFormation stack deployed successfully"
          
          # Create API Gateway deployment
          echo "ðŸš€ Creating API Gateway deployment..."
          DEPLOYMENT_ID=$(aws apigateway create-deployment \
            --rest-api-id q2b9avfwv5 \
            --stage-name prod \
            --description "Simplified backend deployment $(date)" \
            --region us-east-2 \
            --query 'id' \
            --output text)
            
          echo "âœ… API Gateway deployment created: $DEPLOYMENT_ID"
          echo
          echo "ðŸŽ¯ Simplified Backend Deployment Complete!"
          echo "ðŸ“‹ New Endpoints:"
          echo "  âœ… /pm-projects/all-projects â†’ projectMetadataEnricher"
          echo "  âœ… /pm-projects/{pmEmail} â†’ projectMetadataEnricher"
          echo "  âœ… /projects â†’ projectMetadataEnricher"
          echo "  âœ… /check-document/{projectId} â†’ projectMetadataEnricher"

      # â”€â”€â”€ 5.6. Test Backend Endpoints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§ª Test Backend Endpoints
        if: ${{ inputs.test_backend_endpoints || github.event_name == 'push' }}
        run: |
          echo "ðŸ§ª Testing Backend Endpoints"
          echo "============================"
          
          BASE_URL="https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"
          echo "ðŸ”— Base URL: $BASE_URL"
          echo
          
          # Function to test endpoint
          test_endpoint() {
            local method=$1
            local endpoint=$2
            local description=$3
            
            echo "ðŸ” Testing: $description"
            echo "   $method $endpoint"
            
            response=$(curl -s -w "HTTPSTATUS:%{http_code}" "$BASE_URL$endpoint" 2>/dev/null || echo "HTTPSTATUS:000")
            status_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            
            if [ "$status_code" = "200" ]; then
                echo "   âœ… Status: $status_code (Working)"
            elif [ "$status_code" = "403" ]; then
                echo "   âœ… Status: $status_code (Auth Required - Expected for PM endpoints)"
            elif [ "$status_code" = "404" ]; then
                echo "   âŒ Status: $status_code (Not Found - Check deployment)"
            else
                echo "   âš ï¸  Status: $status_code"
            fi
            echo
          }
          
          echo "ðŸ“‹ Testing NEW PM Endpoints (routed to projectMetadataEnricher):"
          test_endpoint "GET" "/pm-projects/all-projects" "PM Projects (All)"
          test_endpoint "GET" "/pm-projects/test@example.com" "PM Projects (By Email)"
          test_endpoint "GET" "/projects" "Projects List"
          test_endpoint "GET" "/check-document/test?format=docx" "Document Status (GET)"
          
          echo "ðŸ“‹ Testing EXISTING Endpoints:"
          test_endpoint "GET" "/health" "Health Check"
          test_endpoint "GET" "/project-summary/test" "Project Summary"
          
          echo "âœ… Backend endpoint testing completed"

      # â”€â”€â”€ 6. Sync to S3 + Push SPA Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Sync dist/ to S3
        env:
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          set -eux
          aws s3 sync dist "s3://$BUCKET" --delete
          bash scripts/push-spa-routes.sh

      - name: ðŸ§¾ Log current S3 contents
        env:
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          echo "âœ… Dumping full contents of s3://$BUCKET:"
          aws s3 ls s3://$BUCKET/ --recursive

      # â”€â”€â”€ 7. Ensure CF root object = index.html â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ› ï¸ Set CF root object if needed
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          set -euo pipefail
          tmp=$(mktemp)
          aws cloudfront get-distribution-config --id "$DIST_ID" > "$tmp"
          etag=$(jq -r .ETag "$tmp")
          jq '
            .DistributionConfig as $cfg
            | if $cfg.DefaultRootObject != "index.html"
              then $cfg.DefaultRootObject = "index.html" | $cfg
              else empty end
          ' "$tmp" > /tmp/cf_patch.json
          if [ -s /tmp/cf_patch.json ]; then
            aws cloudfront update-distribution \
              --id "$DIST_ID" \
              --if-match "$etag" \
              --distribution-config file:///tmp/cf_patch.json
            echo "ðŸ”„ CF root object set to index.html"
          else
            echo "âœ… CF root object already index.html"
          fi
          rm -f "$tmp"

      # â”€â”€â”€ 8. OAC Policy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Apply S3 bucket policy for CloudFront
        env:
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
          REGION: ${{ secrets.AWS_REGION }}
        run: |
          ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          cat > /tmp/s3-oac-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "AllowCloudFrontOACAccess",
                "Effect": "Allow",
                "Principal": { "Service": "cloudfront.amazonaws.com" },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::$BUCKET/*",
                "Condition": {
                  "StringEquals": {
                    "AWS:SourceArn": "arn:aws:cloudfront::$ACCOUNT:distribution/$DIST_ID"
                  }
                }
              }
            ]
          }
          EOF
          aws s3api put-bucket-policy \
            --bucket "$BUCKET" \
            --policy file:///tmp/s3-oac-policy.json \
            --region "$REGION"

      # â”€â”€â”€ 9. Invalidate CloudFront Cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”„ CloudFront Invalidate /* and log status
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          INV=$(aws cloudfront create-invalidation \
            --distribution-id "$DIST_ID" \
            --paths '/*' \
            --query 'Invalidation.Id' --output text)
          echo "ðŸ•’ Waiting for CloudFront invalidation $INVâ€¦"
          aws cloudfront wait invalidation-completed \
            --distribution-id "$DIST_ID" --id "$INV"

      # â”€â”€â”€ 10. Final CF URL Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŒ Verify /login and /dashboard via CF
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          CF_DOMAIN=$(aws cloudfront get-distribution \
            --id "$DIST_ID" --query 'Distribution.DomainName' --output text)

          echo "âœ… CloudFront Domain: https://$CF_DOMAIN"

          echo "â–¶ï¸ /login:"
          curl -i https://$CF_DOMAIN/login || true

          echo "â–¶ï¸ /dashboard:"
          curl -i https://$CF_DOMAIN/dashboard || true

      # â”€â”€â”€ 11. ENHANCED: Full Deployment Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Complete Deployment Summary
        run: |
          echo "ðŸŽ‰ COMPLETE ACTA-UI DEPLOYMENT SUMMARY"
          echo "====================================="
          echo "ðŸ• Deployed: $(date)"
          echo
          echo "ðŸŽ¯ FRONTEND:"
          echo "  âœ… Built with Vite"
          echo "  âœ… Deployed to S3"
          echo "  âœ… CloudFront distribution updated"
          echo "  âœ… Cache invalidated"
          echo
          echo "ðŸŽ¯ BACKEND (Simplified Lambda-Centric):"
          echo "  âœ… All PM endpoints routed to projectMetadataEnricher"
          echo "  âœ… No new Lambda functions needed"
          echo "  âœ… No DynamoDB costs"
          echo "  âœ… API Gateway deployment updated"
          echo
          echo "ðŸ”— ENDPOINTS:"
          echo "  Frontend: https://d7t9x3j66yd8k.cloudfront.net"
          echo "  Backend:  https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"
          echo
          echo "ðŸ“‹ NEW BACKEND ROUTES:"
          echo "  âœ… GET /pm-projects/all-projects"
          echo "  âœ… GET /pm-projects/{pmEmail}"
          echo "  âœ… GET /projects"  
          echo "  âœ… GET /check-document/{projectId}"
          echo "  âœ… HEAD /check-document/{projectId}"
          echo
          echo "ðŸ’¡ NEXT STEPS:"
          echo "  1. Test with authentication tokens"
          echo "  2. Enhance projectMetadataEnricher for PM queries"
          echo "  3. Update frontend to use browser storage"
          echo "  4. Remove DynamoDB dependencies (optional)"
          echo
          echo "ðŸ† DEPLOYMENT SUCCESSFUL!"
