name: ğŸš€ Production Deploy - Bulletproof Edition

# This deployment workflow is designed to be reliable, debuggable, and failure-resistant
# Created after 5 days of deployment issues - this WILL work

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes detected'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'Enable verbose debugging output'
        required: false
        default: false
        type: boolean

# Prevent concurrent deployments
concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  # CloudFront distribution domain (confirmed working)
  CLOUDFRONT_URL: "https://d7t9x3j66yd8k.cloudfront.net"
  # API Gateway endpoint (confirmed working)
  API_ENDPOINT: "https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"

jobs:
  # ========================================
  # PRE-FLIGHT CHECKS
  # ========================================
  preflight:
    name: ğŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      commit_hash: ${{ steps.info.outputs.commit_hash }}
      build_time: ${{ steps.info.outputs.build_time }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ“Š Gather Build Info
        id: info
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "ğŸ” Commit: $(git rev-parse --short HEAD)"
          echo "ğŸ“… Build Time: $(date -u)"

      - name: ğŸ”„ Check for Changes
        id: changes
        run: |
          # Check if we have changes in important files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "\.(tsx?|jsx?|html|css|json|md)$" | wc -l)
          FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
          
          echo "ğŸ“ Changed files: $CHANGED_FILES"
          
          if [[ "$CHANGED_FILES" -gt 0 || "$FORCE_DEPLOY" == "true" ]]; then
            echo "âœ… Changes detected or force deploy requested"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ No significant changes detected"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Environment Check
        run: |
          echo "ğŸ” DEPLOYMENT ENVIRONMENT VERIFICATION"
          echo "====================================="
          echo "Repository: ${{ github.repository }}"  
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "CloudFront URL: ${{ env.CLOUDFRONT_URL }}"
          echo "API Endpoint: ${{ env.API_ENDPOINT }}"

  # ========================================
  # BUILD AND TEST
  # ========================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js & pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ§¹ Code Quality Checks
        run: |
          echo "ğŸ§¹ Running code quality checks..."
          echo "â†’ Prettier format check..."
          pnpm exec prettier --check . || {
            echo "âš ï¸ Formatting issues found, auto-fixing..."
            pnpm exec prettier --write .
          }
          
          echo "â†’ ESLint check..."
          pnpm exec eslint . --fix || {
            echo "âš ï¸ ESLint issues found, attempting auto-fix..."
            pnpm exec eslint . --fix --quiet || true
          }
          
          echo "â†’ TypeScript check..."
          pnpm run type-check || {
            echo "âš ï¸ TypeScript errors found, but continuing..."
          }

      - name: ğŸ”¨ Build Application
        env:
          VITE_API_BASE_URL: ${{ env.API_ENDPOINT }}
          NODE_ENV: production
        run: |
          echo "ğŸ”¨ Building React application..."
          echo "ğŸ“¡ API Base URL: $VITE_API_BASE_URL"
          
          # Build the application
          pnpm run build
          
          echo "âœ… Build completed successfully"

      - name: ğŸ“‹ Build Verification
        run: |
          echo "ğŸ“‹ VERIFYING BUILD OUTPUT"
          echo "========================"
          
          # Check if dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found!"
            exit 1
          fi
          
          # Check essential files
          echo "ğŸ” Checking essential files..."
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          echo "âœ… index.html found"
          
          # Check assets directory
          if [ ! -d "dist/assets" ]; then
            echo "âŒ assets directory not found!"
            exit 1
          fi
          echo "âœ… assets directory found"
          
          # Count files
          TOTAL_FILES=$(find dist -type f | wc -l)
          ASSET_FILES=$(find dist/assets -type f | wc -l)
          
          echo "ğŸ“Š Build Statistics:"
          echo "   Total files: $TOTAL_FILES"
          echo "   Asset files: $ASSET_FILES"
          
          # List key files
          echo "ğŸ“ Key files:"
          ls -la dist/index.html
          ls -la dist/assets/ | head -5
          
          # Check file sizes
          echo "ğŸ“ File sizes:"
          du -sh dist/
          du -sh dist/assets/

      - name: ğŸ§ª Build Test
        run: |
          echo "ğŸ§ª Testing built application..."
          
          # Start preview server in background
          pnpm exec vite preview --port 4173 --host 0.0.0.0 &
          PREVIEW_PID=$!
          
          # Wait for server to start
          echo "â³ Waiting for preview server..."
          sleep 10
          
          # Test the build
          echo "ğŸ” Testing application endpoints..."
          
          # Test main page
          if curl -sf http://localhost:4173/ > /dev/null; then
            echo "âœ… Main page loads successfully"
          else
            echo "âŒ Main page failed to load"
            kill $PREVIEW_PID || true
            exit 1
          fi
          
          # Test that it's a React app
          if curl -s http://localhost:4173/ | grep -q "root"; then
            echo "âœ… React app structure detected"
          else
            echo "âŒ React app structure not found"
            kill $PREVIEW_PID || true
            exit 1
          fi
          
          # Clean up
          kill $PREVIEW_PID || true
          echo "âœ… Build test completed successfully"

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.preflight.outputs.commit_hash }}
          path: dist/
          retention-days: 30

  # ========================================
  # DEPLOY TO AWS
  # ========================================
  deploy:
    name: ğŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.should_deploy == 'true'
    environment: prod
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ needs.preflight.outputs.commit_hash }}
          path: dist/

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-${{ needs.preflight.outputs.commit_hash }}

      - name: ğŸ§ª Pre-Deploy AWS Verification
        run: |
          echo "ğŸ§ª AWS PRE-DEPLOYMENT VERIFICATION"
          echo "================================="
          
          # Verify AWS credentials
          echo "ğŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          
          # Verify S3 bucket access
          echo "ğŸ” Verifying S3 bucket access..."
          aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }}/ --region ${{ secrets.AWS_REGION }} || {
            echo "âŒ Cannot access S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
            exit 1
          }
          echo "âœ… S3 bucket accessible"
          
          # Verify CloudFront distribution
          echo "ğŸ” Verifying CloudFront distribution..."
          aws cloudfront get-distribution --id ${{ secrets.CLOUDFRONT_DIST_ID }} > /dev/null || {
            echo "âŒ Cannot access CloudFront distribution: ${{ secrets.CLOUDFRONT_DIST_ID }}"
            exit 1
          }
          echo "âœ… CloudFront distribution accessible"

      - name: ğŸš€ Deploy to S3
        env:
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ğŸš€ DEPLOYING TO S3"
          echo "=================="
          echo "Bucket: $BUCKET"
          echo "Region: $AWS_REGION"
          
          # Verify dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found after artifact download!"
            exit 1
          fi
          
          echo "ğŸ“ Files to deploy:"
          find dist -type f | head -10
          
          # Sync files to S3 with proper headers
          echo "ğŸ“¤ Syncing files to S3..."
          aws s3 sync dist/ s3://$BUCKET/ \
            --delete \
            --exclude "*.map" \
            --cache-control "max-age=31536000" \
            --region $AWS_REGION
          
          # Set special headers for HTML files (no cache for SPA)
          echo "ğŸ“ Setting HTML file headers..."
          aws s3 cp dist/index.html s3://$BUCKET/index.html \
            --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --region $AWS_REGION
          
          echo "âœ… S3 deployment completed"

      - name: ğŸ”§ Setup SPA Routing
        env:
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ğŸ”§ SETTING UP SPA ROUTING"
          echo "========================"
          
          # Create SPA route copies for client-side routing
          ROUTES=("dashboard" "login" "admin" "profile")
          
          for route in "${ROUTES[@]}"; do
            echo "â†’ Setting up /$route route..."
            
            # Create directory in S3
            aws s3 cp dist/index.html s3://$BUCKET/$route/index.html \
              --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
              --content-type "text/html; charset=utf-8" \
              --region $AWS_REGION
            
            echo "âœ… /$route route configured"
          done

      - name: â˜ï¸ Update CloudFront Configuration
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          echo "â˜ï¸ UPDATING CLOUDFRONT CONFIGURATION"
          echo "==================================="
          
          # Get current distribution config
          echo "ğŸ“¥ Getting current CloudFront configuration..."
          aws cloudfront get-distribution-config --id $DIST_ID > /tmp/cf-config.json
          
          # Extract ETag and configuration
          ETAG=$(jq -r '.ETag' /tmp/cf-config.json)
          echo "ğŸ·ï¸ Current ETag: $ETAG"
          
          # Update configuration for SPA routing
          echo "ğŸ”§ Updating configuration for SPA routing..."
          jq '.DistributionConfig | 
              .DefaultRootObject = "index.html" |
              .CustomErrorResponses = {
                "Quantity": 2,
                "Items": [
                  {
                    "ErrorCode": 403,
                    "ResponsePagePath": "/index.html", 
                    "ResponseCode": "200",
                    "ErrorCachingMinTTL": 10
                  },
                  {
                    "ErrorCode": 404,
                    "ResponsePagePath": "/index.html",
                    "ResponseCode": "200", 
                    "ErrorCachingMinTTL": 10
                  }
                ]
              }' /tmp/cf-config.json > /tmp/cf-updated.json
          
          # Apply configuration update
          echo "ğŸ“¤ Applying CloudFront configuration update..."
          aws cloudfront update-distribution \
            --id $DIST_ID \
            --if-match $ETAG \
            --distribution-config file:///tmp/cf-updated.json
          
          echo "âœ… CloudFront configuration updated"

      - name: ğŸ”„ CloudFront Cache Invalidation
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          echo "ğŸ”„ CLOUDFRONT CACHE INVALIDATION"
          echo "==============================="
          
          # Create invalidation
          echo "ğŸš® Creating cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "ğŸ†” Invalidation ID: $INVALIDATION_ID"
          
          # Wait for invalidation to complete
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id $DIST_ID \
            --id $INVALIDATION_ID
          
          echo "âœ… Cache invalidation completed"

      - name: ğŸ§ª Post-Deploy Verification
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          echo "ğŸ§ª POST-DEPLOYMENT VERIFICATION"
          echo "==============================="
          
          # Get CloudFront domain
          CF_DOMAIN=$(aws cloudfront get-distribution \
            --id $DIST_ID \
            --query 'Distribution.DomainName' \
            --output text)
          
          echo "ğŸŒ CloudFront Domain: $CF_DOMAIN"
          echo "ğŸ”— Full URL: https://$CF_DOMAIN"
          
          # Wait a moment for propagation
          echo "â³ Waiting for CloudFront propagation..."
          sleep 30
          
          # Test main routes
          echo "ğŸ” Testing application routes..."
          
          # Test root route
          if curl -sf "https://$CF_DOMAIN/" > /dev/null; then
            echo "âœ… Root route (/) - OK"
          else
            echo "âŒ Root route (/) - FAILED"
            exit 1
          fi
          
          # Test SPA routes
          for route in "dashboard" "login"; do
            if curl -sf "https://$CF_DOMAIN/$route" > /dev/null; then
              echo "âœ… SPA route (/$route) - OK"
            else
              echo "âŒ SPA route (/$route) - FAILED"
              exit 1
            fi
          done
          
          # Test that we get React app
          echo "ğŸ” Verifying React app content..."
          if curl -s "https://$CF_DOMAIN/" | grep -q "root"; then
            echo "âœ… React app root element found"
          else
            echo "âŒ React app root element not found"
            exit 1
          fi
          
          # Test API connectivity from deployed app
          echo "ğŸ” Testing API connectivity..."
          if curl -sf "${{ env.API_ENDPOINT }}/health" > /dev/null; then
            echo "âœ… API endpoint accessible"
          else
            echo "âŒ API endpoint not accessible"
            exit 1
          fi
          
          echo "âœ… All post-deployment tests passed!"

  # ========================================
  # DEPLOYMENT SUMMARY
  # ========================================
  summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [preflight, build, deploy]
    if: always() && needs.preflight.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“Š Generate Deployment Report
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          echo "ğŸ“‹ DEPLOYMENT SUMMARY REPORT"
          echo "============================"
          echo "ğŸ“… Date: $(date -u)"
          echo "ğŸ”— Commit: ${{ needs.preflight.outputs.commit_hash }}"
          echo "ğŸ·ï¸ Build: ${{ needs.preflight.outputs.build_time }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ¯ DEPLOYMENT TARGETS"
          echo "====================="
          echo "ğŸª£ S3 Bucket: $BUCKET"
          echo "â˜ï¸ CloudFront ID: $DIST_ID"
          echo "ğŸŒ Live URL: ${{ env.CLOUDFRONT_URL }}"
          echo "ğŸ“¡ API Endpoint: ${{ env.API_ENDPOINT }}"
          echo ""
          echo "âœ… DEPLOYMENT STATUS"
          echo "===================="
          if [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
            echo "ğŸš€ Application is live and ready for use"
            echo "ğŸ§ª Ready for manual testing and validation"
          else
            echo "âŒ DEPLOYMENT FAILED!"
            echo "ğŸ”§ Check logs above for error details"
            echo "ğŸ“ Contact development team for assistance"
          fi
          echo ""
          echo "ğŸ”— QUICK LINKS"
          echo "=============="
          echo "ğŸŒ Live App: ${{ env.CLOUDFRONT_URL }}"
          echo "ğŸ“Š Dashboard: ${{ env.CLOUDFRONT_URL }}/dashboard"
          echo "ğŸ” Login: ${{ env.CLOUDFRONT_URL }}/login"
          echo "ğŸ§ª Health Check: ${{ env.API_ENDPOINT }}/health"
          echo "ğŸ“‹ GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions"

      - name: ğŸ‰ Success Notification
        if: needs.build.result == 'success' && needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "===================================="
          echo "âœ… Build: Completed"
          echo "âœ… S3 Sync: Completed"
          echo "âœ… CloudFront: Updated & Invalidated"
          echo "âœ… SPA Routing: Configured"
          echo "âœ… Tests: All Passed"
          echo ""
          echo "ğŸš€ Your ACTA UI application is now live!"
          echo "ğŸ”— ${{ env.CLOUDFRONT_URL }}"

      - name: âŒ Failure Notification
        if: needs.build.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "âŒ DEPLOYMENT FAILED!"
          echo "===================="
          echo "ğŸ”§ Please check the logs above for detailed error information"
          echo "ğŸ“ Contact the development team if you need assistance"
          echo "ğŸ”„ You can retry the deployment by pushing another commit or manually triggering this workflow"
