# ====================================================================
#  ACTA-UI POST-DEPLOY AUDIT
#  Validates build integrity + production health after each deploy.
#  Author: AIGOR | CVDex Tech Solutions
# ====================================================================

name: ACTA-UI Post-Deploy Audit

# â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  # 1ï¸âƒ£  Runs automatically when the deploy workflow finishes.
  workflow_run:
    workflows: ["Deploy ACTA-UI"]   # â† name of your deploy workflow
    types: [completed]

  # 2ï¸âƒ£  Can be started manually from Actions tab.
  workflow_dispatch: {}

# â”€â”€ Global env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  AWS_REGION: us-east-2
  CLOUDFRONT_DOMAIN: d7t9x3j66yd8k.cloudfront.net
  HEALTH_URL: https://d7t9x3j66yd8k.cloudfront.net/health   # simple /health route

permissions:
  contents: read
  id-token: write               # required for OIDC â†’ AWS STS

concurrency:
  group: post-deploy-audit
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    # â”€â”€ 1 Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v4

    # â”€â”€ 2 Node + pnpm toolchain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/setup-node@v3
      with:
        node-version: 18          # keep in sync with local dev
        cache: pnpm               # speeds up subsequent runs

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9                # matches packageManager field
        run_install: false        # we install in next step

    # â”€â”€ 3 Dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    # â”€â”€ 4 Static Quality Gates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run CI checks
      run: pnpm run ci

    - name: Build (Vite prod)
      run: pnpm run build

    # â”€â”€ 5 AWS OIDC (optional but handy for S3/DDB checks) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume:  ${{ secrets.OIDC_AWS_ROLE_ARN }}
        aws-region:      ${{ env.AWS_REGION }}

    # â”€â”€ 6 Production Smoke - CloudFront health-check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Verify CloudFront health endpoint
      run: |
        echo "ğŸ” Checking $HEALTH_URL"
        status=$(curl -s -o /dev/null -w '%{http_code}' "$HEALTH_URL")
        if [ "$status" != "200" ]; then
          echo "::error::Health check failed â€“ HTTP $status"
          exit 1
        fi
        echo "âœ… CloudFront health OK (200)"

    # â”€â”€ 7 Success banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Report success
      if: success()
      run: echo "ğŸ‰ Post-deploy audit passed â€“ all gates green!"
