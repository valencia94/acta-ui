name: Deploy UI to S3 + CloudFront

on:
  push:
    branches: [ develop ]     # deploy from develop
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_DIR: dist             # passed into deploy_ui.sh

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1) Checkout source
    # --------------------------------------------------
    - name: ‚¨áÔ∏è  Checkout code
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2) Install Node 22.x (matches package.json engines)
    # --------------------------------------------------
    - name: üü¢  Setup Node 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'         # built-in cache for pnpm store

    # --------------------------------------------------
    # 3) Install deps & build bundle with Vite
    #    ‚Äî pins pnpm 9.x via Corepack
    # --------------------------------------------------
    - name: üì¶  Install dependencies & build
      run: |
        corepack enable
        corepack prepare pnpm@9 --activate     # ensure correct pnpm
        pnpm install --no-frozen-lockfile      # prod + dev deps
        pnpm run build                         # outputs to dist/
      env:
        # no NODE_ENV here ‚Äì we need devDeps for Vite
        CI: true

    # --------------------------------------------------
    # 4) AWS credentials via GitHub OIDC
    # --------------------------------------------------
    - name: üîê  Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region:     ${{ secrets.AWS_REGION }}

    # --------------------------------------------------
    # 5) Sync to S3 & invalidate CloudFront
    # --------------------------------------------------
    - name: üöÄ  Deploy to S3 + CloudFront
      run: |
        chmod +x scripts/deploy_ui.sh
        ./scripts/deploy_ui.sh
      env:
        AWS_REGION:         ${{ secrets.AWS_REGION }}
        S3_BUCKET_NAME:     ${{ secrets.S3_BUCKET_NAME }}
        CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        BUILD_DIR:          ${{ env.BUILD_DIR }}
