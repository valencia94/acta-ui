name: Deploy UI to S3 + CloudFront

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_DIR: dist

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      # 1) checkout the repo
      - name: ‚¨áÔ∏è  Checkout code
        uses: actions/checkout@v4

      # 2) Node 22 + pnpm 9
      - name: üü¢  Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: üü¢  Setup pnpm 9
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate

      # 3) install & build
      - name: üì¶  Install deps + build
        run: |
          pnpm install --frozen-lockfile          # prod + dev deps
          pnpm run build                          # ‚Üí dist/
        env:
          CI: true                                # disable interactive hooks

      # 4) assume role for S3/CloudFront
      - name: üîê  Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region:     ${{ secrets.AWS_REGION }}

      # 5) sync to S3 and invalidate CF
      - name: üöÄ  Deploy to S3 + CloudFront
        run: |
          chmod +x scripts/deploy_ui.sh
          ./scripts/deploy_ui.sh
        env:
          AWS_REGION:         ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME:     ${{ secrets.S3_BUCKET_NAME }}
          CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
          BUILD_DIR:          ${{ env.BUILD_DIR }}
