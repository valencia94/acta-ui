name: Deploy UI to S3 + CloudFront

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  BUILD_DIR: dist

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout
    - name: ‚¨áÔ∏è  Checkout code
      uses: actions/checkout@v4

    # 2) Node 22 (no cache key ‚Äî avoids pnpm lookup)
    - name: üü¢  Setup Node 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    # 3) Install deps & build (Core-pack installs pnpm 9)
    - name: üì¶  Install dependencies & build
      run: |
        corepack enable
        corepack prepare pnpm@9 --activate
        pnpm install --no-frozen-lockfile           # prod + dev
        pnpm run build                              # dist/
      env:
        CI: true

    # 4) AWS creds
    - name: üîê  Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region:     ${{ secrets.AWS_REGION }}

    # 5) Deploy
    - name: üöÄ  Deploy to S3 + CloudFront
      run: |
        chmod +x scripts/deploy_ui.sh
        ./scripts/deploy_ui.sh
      env:
        AWS_REGION:         ${{ secrets.AWS_REGION }}
        S3_BUCKET_NAME:     ${{ secrets.S3_BUCKET_NAME }}
        CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        BUILD_DIR:          ${{ env.BUILD_DIR }}
