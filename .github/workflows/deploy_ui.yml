name: Deploy UI to S3 + CloudFront

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

env:
  BUILD_DIR: dist

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      # 1) checkout the repo
      - name: ‚¨áÔ∏è  Checkout code
        uses: actions/checkout@v4

      # 2) Node 20 setup
      - name: üü¢  Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3) pnpm store cache for faster deps
      - name: ‚ôªÔ∏è pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 4) pnpm 9 setup
      - name: üü¢  Setup pnpm 9
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate

      # 5) install & build
      - name: üì¶  Install deps + build
        run: |
          pnpm install --frozen-lockfile          # prod + dev deps
          pnpm run build                          # ‚Üí dist/
        env:
          CI: true # disable interactive hooks

      # 6) assume role for S3/CloudFront
      - name: üîê  Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7) sync to S3 and invalidate CF
      - name: üöÄ  Deploy to S3 + CloudFront
        run: |
          chmod +x scripts/deploy-to-s3.sh
          ./scripts/deploy-to-s3.sh
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
