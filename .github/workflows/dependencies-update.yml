name: Dependencies Update

on:
  schedule:
    - cron: '59 5 * * *'     # dailyâ€‰â€“â€‰UTC 05:59
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      # 1â€Šâ€”â€ŠCheckout develop branch (detached head)
      - name: â¬‡ï¸  Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false   # required for PR action later

      # 2â€Šâ€”â€ŠNode 22 (matches package.json engines)
      - name: ğŸŸ¢  Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: pnpm

      # 3â€Šâ€”â€Špnpm 9 (engines.pnpm)
      - name: ğŸŸ¢  Setup pnpm 9
        uses: pnpm/action-setup@v2
        with:
          version: 9
          cache: true

      # 4â€Šâ€”â€ŠInstall once
      - name: ğŸ“¦  Install dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          CI: true

      # 5â€Šâ€”â€ŠUpgrade minor/patch versions
      - name: â¬†ï¸  Update dependencies (minor)
        run: pnpm run update:minor

      # 6â€Šâ€”â€ŠAudit & fix
      - name: ğŸ”  pnpm audit fix
        run: pnpm audit --fix || true   # never fail the job on audit

      # 7â€Šâ€”â€ŠRe-install after manifest edits
      - name: ğŸ“¦  Re-install after update
        run: pnpm install --no-frozen-lockfile
        env:
          CI: true

      # 8â€Šâ€”â€ŠQuality gates
      - name: ğŸ§¹  ESLint
        run: pnpm run lint
      - name: ğŸ§ª  Vitest
        run: pnpm run test
      - name: ğŸ—ï¸   Build (Vite)
        run: pnpm run build
      # Storybook build is optional; comment in if you rely on it
      # - name: ğŸ“š  Build Storybook
      #   run: pnpm run build:storybook

      # 9â€Šâ€”â€ŠOpen / update PR with changes
      - name: ğŸ”„  Create dependencies-update PR
        uses: ctux/simple-pull-request-gh-action@1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch_main_name: develop
          branch_pr_name: dependencies-update
          commit_message: chore(dependencies): automatic updates
