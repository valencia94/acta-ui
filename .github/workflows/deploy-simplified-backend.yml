name: ğŸ¯ Deploy Simplified Backend (Lambda-Centric)

on:
  workflow_dispatch:
    inputs:
      test_endpoints:
        description: 'Test endpoints after deployment'
        required: true
        default: true
        type: boolean

jobs:
  deploy-simplified-backend:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: acta-simplified-backend-deploy
          aws-region: us-east-2

      - name: ğŸŒ Deploy API Gateway Resources
        run: |
          echo "ğŸŒ Deploying Simplified Backend (Lambda-Centric)"
          echo "==============================================="
          
          # Deploy CloudFormation stack
          aws cloudformation deploy \
            --template-file infra/template-simplified-lambda.yaml \
            --stack-name acta-simplified-backend \
            --parameter-overrides \
              ExistingApiId=q2b9avfwv5 \
              ExistingApiRootResourceId=kw8f8zihjg \
            --capabilities CAPABILITY_IAM \
            --region us-east-2
            
          echo "âœ… CloudFormation stack deployed successfully"
          
          # Create API Gateway deployment
          echo "ğŸš€ Creating API Gateway deployment"
          DEPLOYMENT_ID=$(aws apigateway create-deployment \
            --rest-api-id q2b9avfwv5 \
            --stage-name prod \
            --description "Simplified backend deployment $(date)" \
            --region us-east-2 \
            --query 'id' \
            --output text)
            
          echo "âœ… API Gateway deployment created: $DEPLOYMENT_ID"

      - name: ğŸ§ª Test Simplified Backend Endpoints
        if: ${{ inputs.test_endpoints }}
        run: |
          echo "ğŸ§ª Testing Simplified Backend Endpoints"
          echo "======================================"
          
          BASE_URL="https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"
          
          # Function to test endpoint
          test_endpoint() {
            local method=$1
            local endpoint=$2
            local description=$3
            
            echo "ğŸ” Testing: $description"
            echo "   $method $endpoint"
            
            response=$(curl -s -w "HTTPSTATUS:%{http_code}" "$BASE_URL$endpoint" 2>/dev/null || echo "HTTPSTATUS:000")
            status_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            
            if [ "$status_code" = "200" ]; then
                echo "   âœ… Status: $status_code (Working)"
            elif [ "$status_code" = "403" ]; then
                echo "   âœ… Status: $status_code (Auth Required - Expected)"
            elif [ "$status_code" = "404" ]; then
                echo "   âŒ Status: $status_code (Not Found - Check deployment)"
            else
                echo "   âš ï¸  Status: $status_code"
            fi
            echo
          }
          
          echo "ğŸ“‹ Testing NEW PM Endpoints (routed to projectMetadataEnricher):"
          test_endpoint "GET" "/pm-projects/all-projects" "PM Projects (All)"
          test_endpoint "GET" "/pm-projects/test@example.com" "PM Projects (By Email)"
          test_endpoint "GET" "/projects" "Projects List"
          test_endpoint "GET" "/check-document/test?format=docx" "Document Status (GET)"
          
          echo "ğŸ“‹ Testing EXISTING Endpoints:"
          test_endpoint "GET" "/health" "Health Check"
          test_endpoint "GET" "/project-summary/test" "Project Summary"
          
          echo "âœ… Endpoint testing completed"

      - name: ğŸ“Š Generate Deployment Summary
        run: |
          echo "ğŸ“Š SIMPLIFIED BACKEND DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "ğŸ• Deployed: $(date)"
          echo "ğŸ¯ Architecture: Lambda-Centric (Single Lambda)"
          echo "ğŸ”§ Lambda Function: projectMetadataEnricher"
          echo "ğŸŒ New API Routes:"
          echo "  âœ… /pm-projects/all-projects â†’ projectMetadataEnricher"
          echo "  âœ… /pm-projects/{pmEmail} â†’ projectMetadataEnricher"
          echo "  âœ… /projects â†’ projectMetadataEnricher"
          echo "  âœ… /check-document/{projectId} â†’ projectMetadataEnricher"
          echo "ğŸ”— Base URL: https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod"
          echo
          echo "ğŸ’¡ Benefits of This Approach:"
          echo "  ğŸ¯ Single Lambda handles all project queries"
          echo "  ğŸ’° No DynamoDB costs"
          echo "  ğŸš€ Faster response times"
          echo "  ğŸ”§ Easier to maintain and debug"
          echo "  ğŸ“ˆ Better scalability"
          echo
          echo "ğŸ“ Next Steps:"
          echo "  1. Test with authentication tokens"
          echo "  2. Enhance projectMetadataEnricher to handle PM parameters"
          echo "  3. Update frontend to use browser storage"
          echo "  4. Remove DynamoDB dependencies"
          echo
          echo "ğŸ§ª Test with authentication:"
          echo "curl -H 'Authorization: Bearer your-token' \\"
          echo "  'https://q2b9avfwv5.execute-api.us-east-2.amazonaws.com/prod/pm-projects/all-projects'"
          echo
          echo "ğŸ‰ Simplified backend deployment completed successfully!"
